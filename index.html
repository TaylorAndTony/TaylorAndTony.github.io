<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords"><meta name="author" content="TaylorAndTony,undefined"><meta name="copyright" content="TaylorAndTony"><title>【Hexo】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!-- link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!-- link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!-- script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- script(src=url_for("/js/mathjax/mathjax.js"))--><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"2J9NCG4VA1","apiKey":"e2286fef4db1fed3731c0afa0c68d9ed","indexName":"hexo","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  gitment: {},
  valine: {},
  twikoo: {},
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="author-info"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">TaylorAndTony</div><div class="author-info-description"></div><div class="links-buttons"><a class="links-button button-hover" href="https://github.com/TaylorAndTony" target="_blank">GitHub<i class="icon-dot bg-color5"></i></a><a class="links-button button-hover" href="mailto:doyijian@163.com" target="_blank">E-Mail<i class="icon-dot bg-color3"></i></a><a class="links-button button-hover" href="https://space.bilibili.com/47256272" target="_blank">Bilibili<i class="icon-dot bg-color8"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">26</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">47</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">9</span></a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">Hexo</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><div id="recent-posts"><!-- each post in page.posts.sort('date', -1).limit(10).toArray()--><!-- config中配置按照什么排序--><div class="recent-post-item"><i class="article-top"></i><a class="post-title" href="/2025/01/21/top/">置顶</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2025-01-24</time></div><div class="post-content"><div class="main-content content"><h1 id="✨欢迎来到我的博客✨"><a href="#✨欢迎来到我的博客✨" class="headerlink" title="✨欢迎来到我的博客✨"></a>✨欢迎来到我的博客✨</h1><p>此博客使用 Hexo 搭建，并使用 Github Pages 进行部署，通过 Algolia 完成搜索。</p>
<p>博客主要记录：</p>
<ul>
<li>代码开发日常</li>
<li>Windows&#x2F;Linux 系统配置</li>
<li>各类计算机文章</li>
</ul>
<p>你可以点击左上角<strong><a href="/archives/">归档</a></strong>查看所有发过的文章，或者点击<strong><a href="/tags/">标签</a></strong>，<strong><a href="/categories/">分类</a></strong>查看各个专题。</p>
</div></div><a class="button-hover more" href="/2025/01/21/top/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/2025/01/26/csharp-parse-toml/">C# 解析 TOML</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2025-01-26</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/csharp/">csharp</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/csharp/">csharp</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/toml/">toml</a></div></div><div class="post-content"><div class="main-content content"><h1 id="C-解析-TOML"><a href="#C-解析-TOML" class="headerlink" title="C# 解析 TOML"></a>C# 解析 TOML</h1><h2 id="Tomlyn-库"><a href="#Tomlyn-库" class="headerlink" title="Tomlyn 库"></a>Tomlyn 库</h2><p><a target="_blank" rel="noopener" href="https://github.com/xoofx/Tomlyn">xoofx&#x2F;Tomlyn: Tomlyn is a TOML parser, validator and authoring library for .NET Framework and .NET Core (github.com)</a></p>
<h3 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> toml = <span class="string">@&quot;global = &quot;&quot;this is a string&quot;&quot;</span></span><br><span class="line"><span class="string"># This is a comment of a table</span></span><br><span class="line"><span class="string">[my_table]</span></span><br><span class="line"><span class="string">key = 1 # Comment a key</span></span><br><span class="line"><span class="string">value = true</span></span><br><span class="line"><span class="string">list = [4, 5, 6]</span></span><br><span class="line"><span class="string">&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parse the TOML string to the default runtime model `TomlTable`</span></span><br><span class="line"><span class="keyword">var</span> model = Toml.ToModel(toml);</span><br><span class="line"><span class="comment">// Fetch the string</span></span><br><span class="line"><span class="keyword">var</span> <span class="keyword">global</span> = (<span class="built_in">string</span>)model[<span class="string">&quot;global&quot;</span>]!;</span><br><span class="line"><span class="comment">// Prints: found global = &quot;this is a string&quot;</span></span><br><span class="line">Console.WriteLine(<span class="string">$&quot;found global = \&quot;<span class="subst">&#123;<span class="keyword">global</span>&#125;</span>\&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="解析列表"><a href="#解析列表" class="headerlink" title="解析列表"></a>解析列表</h3><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[[path]]</span></span><br><span class="line"><span class="attr">src</span> = <span class="string">&#x27;E:\# Ultra File Folder&#x27;</span></span><br><span class="line"><span class="attr">dst</span> = <span class="string">&#x27;$:\# Ultra File Folder&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[path]]</span></span><br><span class="line"><span class="attr">src</span> = <span class="string">&#x27;E:\# Ultra File Folder 2133&#x27;</span></span><br><span class="line"><span class="attr">dst</span> = <span class="string">&#x27;$:\# Ultra File Folder 23123&#x27;</span></span><br></pre></td></tr></table></figure>

<p>解析：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Tomlyn.Model.TomlTable model;</span><br><span class="line"></span><br><span class="line">model = Toml.ToModel(File.ReadAllText(...));</span><br><span class="line"></span><br><span class="line">Tomlyn.Model.TomlTableArray paths = (Tomlyn.Model.TomlTableArray)model[<span class="string">&quot;path&quot;</span>]!;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(Tomlyn.Model.TomlTable m <span class="keyword">in</span> paths)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// do sth...</span></span><br><span class="line">    <span class="comment">// extract vars</span></span><br><span class="line">    <span class="built_in">string</span> src, dst, cmd;</span><br><span class="line">    <span class="built_in">bool</span> enableNorm, enableBack;</span><br><span class="line">    <span class="comment">// read vars</span></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        src = (<span class="built_in">string</span>)(reverseDirection ? m[<span class="string">&quot;dst&quot;</span>] : m[<span class="string">&quot;src&quot;</span>]);</span><br><span class="line">        dst = (<span class="built_in">string</span>)(reverseDirection ? m[<span class="string">&quot;src&quot;</span>] : m[<span class="string">&quot;dst&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(ex.Message);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="通用封装-TryGetValue"><a href="#通用封装-TryGetValue" class="headerlink" title="通用封装 TryGetValue"></a>通用封装 TryGetValue</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> try get a value at the TOML table</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>the type of desired value<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span>the key<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;fallbackValue&quot;&gt;</span>if failed, return this value instead<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">TryGetValue</span>&lt;<span class="title">T</span>&gt;(<span class="params">Tomlyn.Model.TomlTable model, <span class="built_in">string</span> key, T fallbackValue</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    fallbackValue = <span class="literal">default</span>;</span><br><span class="line">    <span class="keyword">if</span> (model.ContainsKey(key))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> (T)model[key];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> fallbackValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="单例模式配置中心"><a href="#单例模式配置中心" class="headerlink" title="单例模式配置中心"></a>单例模式配置中心</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ConfigCenterSingleton</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// a unique singleton of this</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConfigCenterSingleton uniqueConfigCenter = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// default path for TOML file</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> path = <span class="string">&quot;config.toml&quot;</span>;</span><br><span class="line">    <span class="comment">// store original toml model</span></span><br><span class="line">    <span class="keyword">private</span> Tomlyn.Model.TomlTable model = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// default encoding</span></span><br><span class="line">    <span class="keyword">private</span> Encoding encoding = Encoding.UTF8;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> load the given toml file into TOML model</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;IOException&quot;&gt;</span><span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadTomlFile</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!File.Exists(path))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">$&quot;Toml config file <span class="subst">&#123;path&#125;</span> does not exists!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (model == <span class="literal">null</span>) model = Tomlyn.Toml.ToModel(File.ReadAllText(path, encoding));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ConfigCenterSingleton</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        LoadTomlFile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ConfigCenterSingleton</span>(<span class="params"><span class="built_in">string</span> path</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        LoadTomlFile();</span><br><span class="line">        <span class="keyword">this</span>.path = path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ConfigCenterSingleton</span>(<span class="params"><span class="built_in">string</span> path, Encoding encoding</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        LoadTomlFile();</span><br><span class="line">        <span class="keyword">this</span>.path = path;</span><br><span class="line">        <span class="keyword">this</span>.encoding = encoding;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> get a singleton instance of ConfigCenter</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigCenterSingleton <span class="title">GetInstance</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (uniqueConfigCenter == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            uniqueConfigCenter = <span class="keyword">new</span> ConfigCenterSingleton();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> uniqueConfigCenter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> get a singleton instance of ConfigCenter</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigCenterSingleton <span class="title">GetInstance</span>(<span class="params"><span class="built_in">string</span> tomlFilePath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (uniqueConfigCenter == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            uniqueConfigCenter = <span class="keyword">new</span> ConfigCenterSingleton(tomlFilePath);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> uniqueConfigCenter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> get a singleton instance of ConfigCenter</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigCenterSingleton <span class="title">GetInstance</span>(<span class="params"><span class="built_in">string</span> tomlFilePath, Encoding encoding</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (uniqueConfigCenter == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            uniqueConfigCenter = <span class="keyword">new</span> ConfigCenterSingleton(tomlFilePath, encoding);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> uniqueConfigCenter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> try get a value at the TOML table</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>the type of desired value<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span>the key<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;fallbackValue&quot;&gt;</span>if failed, return this value instead<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">TryGetValue</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> key, T fallbackValue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        fallbackValue = <span class="literal">default</span>;</span><br><span class="line">        <span class="keyword">if</span> (model.ContainsKey(key))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> (T)model[key];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> fallbackValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> set the value to given value</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;storeToFile&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">SetValue</span>(<span class="params"><span class="built_in">string</span> key, <span class="built_in">object</span> <span class="keyword">value</span>, <span class="built_in">bool</span> storeToFile = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (model.ContainsKey(key))</span><br><span class="line">        &#123;</span><br><span class="line">            model[key] = <span class="keyword">value</span>;</span><br><span class="line">            <span class="keyword">if</span> (storeToFile)</span><br><span class="line">            &#123;</span><br><span class="line">                File.WriteAllText(path, Tomlyn.Toml.FromModel(model), encoding);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> write current model to file immediatly</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">ForceWriteToFile</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            File.WriteAllText(path, Tomlyn.Toml.FromModel(model), encoding);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IOException)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> get the parsed TOML model</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Tomlyn.Model.<span class="function">TomlTable <span class="title">GetModel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> model;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="解析到类"><a href="#解析到类" class="headerlink" title="解析到类"></a>解析到类</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TomlModel <span class="title">Parse</span>(<span class="params"><span class="built_in">string</span> toml</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> model = Toml.ToModel&lt;TomlModel&gt;(toml);</span><br><span class="line">    <span class="keyword">return</span> model;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类定义</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TomlModel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> default_args &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;DiskPath&gt; path &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DiskPath</span> : <span class="title">BaseDataView</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> _src;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> src</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> _src; &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            _src = <span class="keyword">value</span>;</span><br><span class="line">            OnChange();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>BaseDataView</code> —— 一个 <code>INotifyPropertyChanged</code> 帮助类，实现数据绑定中的双向更新。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseDataView</span> : <span class="title">INotifyPropertyChanged</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">event</span> PropertyChangedEventHandler PropertyChanged;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnChange</span>(<span class="params">[CallerMemberName] <span class="built_in">string</span> propertyName = <span class="literal">null</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        PropertyChanged?.Invoke(<span class="keyword">this</span>, <span class="keyword">new</span> PropertyChangedEventArgs(propertyName));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div><a class="button-hover more" href="/2025/01/26/csharp-parse-toml/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/2025/01/26/asp-net-upload-file/">ASP.NET 最小 WebAPI 上传文件</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2025-01-26</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/csharp/">csharp</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/csharp/">csharp</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/asp-net/">asp.net</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/microsoft/">microsoft</a></div></div><div class="post-content"><div class="main-content content"><h1 id="ASP-NET-最小-WebAPI-上传文件"><a href="#ASP-NET-最小-WebAPI-上传文件" class="headerlink" title="ASP.NET 最小 WebAPI 上传文件"></a>ASP.NET 最小 WebAPI 上传文件</h1><h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// accept upload image file</span></span><br><span class="line">app.MapPost(<span class="string">&quot;/api/upload-img/&#123;id&#125;&quot;</span>, <span class="function"><span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">IResult</span>&gt; (<span class="params"><span class="built_in">int</span> id, HttpRequest request</span>)</span> =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    Log.Information(<span class="string">&quot;Upload image request for id: &#123;0&#125;&quot;</span>, id);</span><br><span class="line">    <span class="keyword">if</span> (!loginManager.IsLogin(request.HttpContext.GetIpAddress()))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Results.Json(<span class="keyword">new</span> ServerAckDash()</span><br><span class="line">        &#123;</span><br><span class="line">            Success = <span class="literal">false</span>,</span><br><span class="line">            Message = <span class="string">&quot;Not logged in&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!request.HasFormContentType)</span><br><span class="line">        <span class="keyword">return</span> Results.Json(<span class="keyword">new</span> ServerAckDash()</span><br><span class="line">        &#123;</span><br><span class="line">            Success = <span class="literal">false</span>,</span><br><span class="line">            Message = <span class="string">&quot;Invalid content type&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> form = <span class="keyword">await</span> request.ReadFormAsync();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (form.Files.Any() == <span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">return</span> Results.Json(<span class="keyword">new</span> ServerAckDash()</span><br><span class="line">        &#123;</span><br><span class="line">            Success = <span class="literal">false</span>,</span><br><span class="line">            Message = <span class="string">&quot;No file found&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">file</span> = form.Files.FirstOrDefault();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">file</span> <span class="keyword">is</span> <span class="literal">null</span> || <span class="keyword">file</span>.Length == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> Results.Json(<span class="keyword">new</span> ServerAckDash()</span><br><span class="line">        &#123;</span><br><span class="line">            Success = <span class="literal">false</span>,</span><br><span class="line">            Message = <span class="string">&quot;No file found&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">var</span> stream = <span class="keyword">file</span>.OpenReadStream();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// read image data</span></span><br><span class="line">    <span class="built_in">byte</span>[] data = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="keyword">file</span>.Length];</span><br><span class="line">    <span class="keyword">await</span> stream.ReadAsync(data, <span class="number">0</span>, (<span class="built_in">int</span>)<span class="keyword">file</span>.Length);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// save image to file</span></span><br><span class="line">    <span class="keyword">var</span> fileName = <span class="keyword">file</span>.FileName;</span><br><span class="line">    Log.Information(<span class="string">&quot;Image file name: &#123;0&#125;&quot;</span>, fileName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> storePath = Path.Combine(Directory.GetCurrentDirectory(), <span class="string">&quot;wwwroot&quot;</span>, <span class="string">&quot;customImg&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!Directory.Exists(storePath))</span><br><span class="line">    &#123;</span><br><span class="line">        Directory.CreateDirectory(storePath);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> filePath = Path.Combine(storePath, fileName);</span><br><span class="line">    </span><br><span class="line">    Log.Information(<span class="string">&quot;Image will be write to &#123;0&#125;&quot;</span>, filePath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (File.Exists(filePath))</span><br><span class="line">    &#123;</span><br><span class="line">        File.Delete(filePath);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">var</span> fileStream = <span class="keyword">new</span> FileStream(filePath, FileMode.Create);</span><br><span class="line">    <span class="keyword">await</span> fileStream.WriteAsync(data, <span class="number">0</span>, data.Length);</span><br><span class="line">    fileStream.Close();</span><br><span class="line">    <span class="keyword">return</span> Results.Json(<span class="keyword">new</span> ServerAckDash()</span><br><span class="line">    &#123;</span><br><span class="line">        Success = <span class="literal">true</span>,</span><br><span class="line">        Message = <span class="string">&quot;Image uploaded&quot;</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;).Accepts&lt;IFormFile&gt;(<span class="string">&quot;multipart/form-data&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">uploadImage</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span><br><span class="line">    <span class="keyword">const</span> fileInput = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;bg-input&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> file = fileInput.<span class="property">files</span>[<span class="number">0</span>]; <span class="comment">// 获取选中的文件</span></span><br><span class="line">    formData.<span class="title function_">append</span>(<span class="string">&#x27;file&#x27;</span>, file); <span class="comment">// 将文件添加到FormData对象中</span></span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&#x27;/api/upload-img/&#x27;</span> + id, &#123;</span><br><span class="line">        <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">        <span class="attr">body</span>: formData <span class="comment">// 设置请求体为FormData对象</span></span><br><span class="line">    &#125;)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (data.<span class="property">success</span>) &#123;</span><br><span class="line">            <span class="title class_">Swal</span>.<span class="title function_">fire</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;Image uploaded!&#x27;</span>, <span class="attr">text</span>: data.<span class="property">message</span> &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title class_">Swal</span>.<span class="title function_">fire</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;Image upload failed!&#x27;</span>, <span class="attr">text</span>: data.<span class="property">message</span> &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(error));</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

</div></div><a class="button-hover more" href="/2025/01/26/asp-net-upload-file/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/2025/01/26/blazor-add-api/">ASP.NET Blazor 添加 WebAPI 支持</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2025-01-26</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/csharp/">csharp</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/csharp/">csharp</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/asp-net/">asp.net</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/blazor/">blazor</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/web/">web</a></div></div><div class="post-content"><div class="main-content content"><h1 id="ASP-NET-Blazor-添加-WebAPI-支持"><a href="#ASP-NET-Blazor-添加-WebAPI-支持" class="headerlink" title="ASP.NET Blazor 添加 WebAPI 支持"></a>ASP.NET Blazor 添加 WebAPI 支持</h1><h2 id="Program-cs"><a href="#Program-cs" class="headerlink" title="Program.cs"></a>Program.cs</h2><p>添加服务</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddControllers();</span><br></pre></td></tr></table></figure>

<p>添加控制器</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add support for web api</span></span><br><span class="line">app.MapControllers();</span><br></pre></td></tr></table></figure>

<p>Program.cs 完整代码</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> BlazorApiTest.Components;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(<span class="keyword">args</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add services to the container.</span></span><br><span class="line">builder.Services.AddRazorComponents()</span><br><span class="line">    .AddInteractiveServerComponents();</span><br><span class="line"></span><br><span class="line"><span class="comment">// add support for web api</span></span><br><span class="line">builder.Services.AddControllers();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Configure the HTTP request pipeline.</span></span><br><span class="line"><span class="keyword">if</span> (!app.Environment.IsDevelopment())</span><br><span class="line">&#123;</span><br><span class="line">    app.UseExceptionHandler(<span class="string">&quot;/Error&quot;</span>, createScopeForErrors: <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.UseStaticFiles();</span><br><span class="line">app.UseAntiforgery();</span><br><span class="line"></span><br><span class="line">app.MapRazorComponents&lt;App&gt;()</span><br><span class="line">    .AddInteractiveServerRenderMode();</span><br><span class="line"></span><br><span class="line"><span class="comment">// add support for web api</span></span><br><span class="line">app.MapControllers();</span><br><span class="line"></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure>



<h2 id="编写控制器"><a href="#编写控制器" class="headerlink" title="编写控制器"></a>编写控制器</h2><p>创建 <code>Controllers/BasicController.cs</code> 名称任意</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BlazorApiTest.Controllers</span>;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Route(<span class="string">&quot;api/&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">ApiController</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BasicController</span>: <span class="title">Controller</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">HttpGet(<span class="string">&quot;test&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Get</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, World!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动程序访问 <code>/api/test</code> 即可看到正确回显 <code>Hello, World!</code></p>
<p>或者，使用约定的路由方法</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BlazorApiTest.Controllers</span>;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Route(<span class="string">&quot;api/[controller]/[action]&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">ApiController</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BasicController</span>: <span class="title">Controller</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Hello</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, World! From Hello() method&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Goodbye</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Goodbye, World! From Goodbye() method&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时，访问 <code>/api/Basic/Hello</code> 和 <code>/api/Basic/Goodbye</code> 可看到对应的输出</p>
</div></div><a class="button-hover more" href="/2025/01/26/blazor-add-api/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/2025/01/25/windows-delete-file-err/">Win10 删除文件显示找不到该项目</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2025-01-25</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/software/">software</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/microsoft/">microsoft</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/troubleshoot/">troubleshoot</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/windows/">windows</a></div></div><div class="post-content"><div class="main-content content"><h1 id="Win10-删除一个文件显示找不到该项目"><a href="#Win10-删除一个文件显示找不到该项目" class="headerlink" title="Win10 删除一个文件显示找不到该项目"></a>Win10 删除一个文件显示<code>找不到该项目</code></h1><p>现象：在 explorer 中，选中一个文件，按下 <code>Shift+Delete</code>，弹窗提示<code>找不到该项目</code>。在此目录下使用 <code>dir</code> 命令，可以看到文件存在。</p>
<h2 id="用批处理"><a href="#用批处理" class="headerlink" title="用批处理"></a>用批处理</h2><p>打开空白文档，输入以下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DEL /F /A /Q \\?\%1</span><br><span class="line">RD /S /Q \\?\%1</span><br></pre></td></tr></table></figure>

<p>将文本文档另存为 .bat 文件</p>
<p>将需要删除的文件夹拖拽到 bat 批处理文件上即可完成删除</p>
<h2 id="用git-bash"><a href="#用git-bash" class="headerlink" title="用git bash"></a>用git bash</h2><p>输入命令 <code>rm -rf 文件名</code></p>
<h2 id="放文件"><a href="#放文件" class="headerlink" title="放文件"></a>放文件</h2><p>在文件夹内放一个文件，再删除文件夹</p>
</div></div><a class="button-hover more" href="/2025/01/25/windows-delete-file-err/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/2025/01/25/csharp-open-url/">C# 打开网址</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2025-01-25</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/csharp/">csharp</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/csharp/">csharp</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/microsoft/">microsoft</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/dotnet/">dotnet</a></div></div><div class="post-content"><div class="main-content content"><h1 id="C-打开网址-Process-Start-for-URLs-txt"><a href="#C-打开网址-Process-Start-for-URLs-txt" class="headerlink" title="C# 打开网址 Process Start for URLs.txt"></a>C# 打开网址 Process Start for URLs.txt</h1><p>Apparently .NET Core is sort of broken when it comes to opening a URL via <code>Process.Start</code>. Normally you’d expect to do this:</p>
<p><code>Process.Start(&quot;http://google.com&quot;)</code><br>And then the default system browser pops open and you’re good to go. But this open issue explains that this doesn’t work on .NET Core. So instead you have to do this (credit goes to Eric Mellino):</p>
<h2 id="solution-1-tested"><a href="#solution-1-tested" class="headerlink" title="solution 1 (tested)"></a>solution 1 (tested)</h2><p>use simple one</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Process.Start(<span class="keyword">new</span> ProcessStartInfo() </span><br><span class="line">              &#123;</span><br><span class="line">                  FileName = <span class="string">&quot;cmd&quot;</span>,</span><br><span class="line">                  Arguments = <span class="string">&quot;/c start &quot;</span> + url,</span><br><span class="line">                  UseShellExecute = <span class="literal">false</span>,</span><br><span class="line">                  WindowStyle = ProcessWindowStyle.Hidden,</span><br><span class="line">                  CreateNoWindow = <span class="literal">true</span>,</span><br><span class="line">              &#125;);</span><br></pre></td></tr></table></figure>

<p>or the long one</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenBrowser</span>(<span class="params"><span class="built_in">string</span> url</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        Process.Start(url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// hack because of this: https://github.com/dotnet/corefx/issues/10361</span></span><br><span class="line">        <span class="keyword">if</span> (RuntimeInformation.IsOSPlatform(OSPlatform.Windows))</span><br><span class="line">        &#123;</span><br><span class="line">            url = url.Replace(<span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;^&amp;&quot;</span>);</span><br><span class="line">            Process.Start(<span class="keyword">new</span> ProcessStartInfo(<span class="string">&quot;cmd&quot;</span>, <span class="string">$&quot;/c start <span class="subst">&#123;url&#125;</span>&quot;</span>) &#123; CreateNoWindow = <span class="literal">true</span> &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (RuntimeInformation.IsOSPlatform(OSPlatform.Linux))</span><br><span class="line">        &#123;</span><br><span class="line">            Process.Start(<span class="string">&quot;xdg-open&quot;</span>, url);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (RuntimeInformation.IsOSPlatform(OSPlatform.OSX))</span><br><span class="line">        &#123;</span><br><span class="line">            Process.Start(<span class="string">&quot;open&quot;</span>, url);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="solution-2-tested"><a href="#solution-2-tested" class="headerlink" title="solution 2 (tested)"></a>solution 2 (tested)</h2><p>This was an intentional breaking change in .Net Core. Specifically, <code>UseShellExecute</code>, which is required to be <code>true</code> for your code to work, <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.processstartinfo.useshellexecute">defaults to <code>true</code> on .Net Framework, but it’s <code>false</code> on .Net Core</a>. This means the following code will work on both frameworks:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Process.Start(<span class="keyword">new</span> ProcessStartInfo(<span class="string">&quot;https://www.google.com&quot;</span>) &#123; UseShellExecute = <span class="literal">true</span> &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="solution-3"><a href="#solution-3" class="headerlink" title="solution 3"></a>solution 3</h2><p><strong><a target="_blank" rel="noopener" href="https://github.com/dsplaisted">dsplaisted</a></strong> commented <a target="_blank" rel="noopener" href="https://github.com/dotnet/runtime/issues/28005#issuecomment-442214248">on Nov 28, 2018</a></p>
<p>I believe the currently recommended workaround is to set <code>UseShellExecute</code> to true:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ProcessStartInfo psi = <span class="keyword">new</span> ProcessStartInfo</span><br><span class="line">&#123;</span><br><span class="line">    FileName = url,</span><br><span class="line">    UseShellExecute = <span class="literal">true</span></span><br><span class="line">&#125;;</span><br><span class="line">Process.Start (psi);</span><br></pre></td></tr></table></figure>

<p><strong><a target="_blank" rel="noopener" href="https://github.com/clairernovotny">clairernovotny</a></strong> commented <a target="_blank" rel="noopener" href="https://github.com/dotnet/runtime/issues/28005#issuecomment-442214640">on Nov 28, 2018</a> • edited </p>
<p>You need this instead</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ProcessStartInfo psi = <span class="keyword">new</span> ProcessStartInfo</span><br><span class="line">&#123;</span><br><span class="line">    FileName = <span class="string">&quot;cmd&quot;</span>,</span><br><span class="line">    Arguments = <span class="string">&quot;/c start https://www.baidu.com/s?wd=beijing%20time&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line">Process.Start(psi);</span><br></pre></td></tr></table></figure>

<p>Which is ugly…and more likely to bite people, I think.</p>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/clairernovotny">clairernovotny</a></strong> commented <a target="_blank" rel="noopener" href="https://github.com/dotnet/runtime/issues/28005#issuecomment-442217271">on Nov 28, 2018</a></p>
<p>Actually it’s worse than that, here’s what you need to do it right <strong>so no cmd window appears</strong>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> psi = <span class="keyword">new</span> ProcessStartInfo</span><br><span class="line">&#123;</span><br><span class="line">    FileName = <span class="string">&quot;cmd&quot;</span>,</span><br><span class="line">    WindowStyle = ProcessWindowStyle.Hidden,</span><br><span class="line">    UseShellExecute = <span class="literal">false</span>,</span><br><span class="line">    CreateNoWindow = <span class="literal">true</span>,</span><br><span class="line">    Arguments = <span class="string">$&quot;/c start <span class="subst">&#123;link.AbsoluteUri&#125;</span>&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line">Process.Start(psi);</span><br></pre></td></tr></table></figure>

</div></div><a class="button-hover more" href="/2025/01/25/csharp-open-url/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/2025/01/25/csharp-images/">C# bitmap 图片编码及压缩参数</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2025-01-25</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/csharp/">csharp</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/csharp/">csharp</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/microsoft/">microsoft</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/dotnet/">dotnet</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/cv/">cv</a></div></div><div class="post-content"><div class="main-content content"><h1 id="C-bitmap图片编码及压缩参数"><a href="#C-bitmap图片编码及压缩参数" class="headerlink" title="C# bitmap图片编码及压缩参数"></a>C# bitmap图片编码及压缩参数</h1><h2 id="读取图片"><a href="#读取图片" class="headerlink" title="读取图片"></a>读取图片</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Image img = Image.FromFile(imgFile);</span><br></pre></td></tr></table></figure>

<h2 id="ImageCodecInfo-帮助方法"><a href="#ImageCodecInfo-帮助方法" class="headerlink" title="ImageCodecInfo 帮助方法"></a>ImageCodecInfo 帮助方法</h2><p>简写：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ImageCodecInfo <span class="title">GetEncoder</span>(<span class="params">ImageFormat format</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> codecs = ImageCodecInfo.GetImageDecoders();</span><br><span class="line">    <span class="keyword">return</span> codecs.FirstOrDefault(codec =&gt; codec.FormatID == format.Guid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原始</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ImageCodecInfo <span class="title">GetEncoder</span>(<span class="params">ImageFormat format</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ImageCodecInfo[] codecs = ImageCodecInfo.GetImageEncoders();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (ImageCodecInfo codec <span class="keyword">in</span> codecs)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (codec.FormatID == format.Guid)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> codec;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="编码及压缩"><a href="#编码及压缩" class="headerlink" title="编码及压缩"></a>编码及压缩</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Bitmap target = <span class="keyword">new</span> Bitmap(width, height);</span><br><span class="line"></span><br><span class="line"><span class="comment">// format and encoder</span></span><br><span class="line"><span class="comment">// the format is used by the encoder</span></span><br><span class="line"><span class="comment">// to generate ImageCodecInfo</span></span><br><span class="line">ImageFormat format = ImageFormat.Jpeg;</span><br><span class="line">ImageCodecInfo encoder = GetEncoder(format);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Bitmap.Save takes the EncoderParameters,</span></span><br><span class="line"><span class="comment">// but what we make is a EncoderParameter, no &quot;s&quot; at the end.</span></span><br><span class="line"><span class="comment">// use EncoderParameters.Param[0] to assign</span></span><br><span class="line">EncoderParameters pm = <span class="keyword">new</span> EncoderParameters(<span class="number">1</span>);</span><br><span class="line">pm.Param[<span class="number">0</span>] = <span class="keyword">new</span> EncoderParameter(Encoder.Quality, <span class="number">80L</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> filename = ...</span><br><span class="line">target.Save(filename, encoder, pm);</span><br></pre></td></tr></table></figure>

<h2 id="附：裁剪图片"><a href="#附：裁剪图片" class="headerlink" title="附：裁剪图片"></a>附：裁剪图片</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Rectangle cropRect = <span class="keyword">new</span> Rectangle(x, y, width, height);</span><br><span class="line"></span><br><span class="line">Bitmap target = <span class="keyword">new</span> Bitmap(width, height);</span><br><span class="line">Graphics g = Graphics.FromImage(target);</span><br><span class="line">g.DrawImage(img, </span><br><span class="line">            <span class="keyword">new</span> Rectangle(<span class="number">0</span>, <span class="number">0</span>, target.Width, target.Height),</span><br><span class="line">            cropRect,</span><br><span class="line">            GraphicsUnit.Pixel);</span><br></pre></td></tr></table></figure>

</div></div><a class="button-hover more" href="/2025/01/25/csharp-images/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/2025/01/25/csharp-popups/">C# 弹窗获取文件等</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2025-01-25</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/csharp/">csharp</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/csharp/">csharp</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/microsoft/">microsoft</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/dotnet/">dotnet</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/wpf/">wpf</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/winform/">winform</a></div></div><div class="post-content"><div class="main-content content"><h1 id="C-弹窗获取文件等"><a href="#C-弹窗获取文件等" class="headerlink" title="C#弹窗获取文件等"></a>C#弹窗获取文件等</h1><h2 id="Winform获取文件"><a href="#Winform获取文件" class="headerlink" title="Winform获取文件"></a>Winform获取文件</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件选取 这里只允许txt文件</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">button1_Click</span>(<span class="params"><span class="built_in">object</span> sender, EventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    OpenFileDialog dialog = <span class="keyword">new</span> OpenFileDialog();</span><br><span class="line">    dialog.Multiselect = <span class="literal">false</span>;   <span class="comment">//是否允许多选</span></span><br><span class="line">    dialog.Title = <span class="string">&quot;请选择要处理的文件&quot;</span>;  <span class="comment">//窗口title</span></span><br><span class="line">    dialog.Filter = <span class="string">&quot;文本文件(*.txt)|*.*&quot;</span>;   <span class="comment">//可选择的文件类型</span></span><br><span class="line">    <span class="keyword">if</span> (dialog.ShowDialog() == System.Windows.Forms.DialogResult.OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> path = dialog.FileName;  <span class="comment">//获取文件路径</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Winform另存为"><a href="#Winform另存为" class="headerlink" title="Winform另存为"></a>Winform另存为</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SaveFileDialog savedialog = <span class="keyword">new</span> SaveFileDialog();</span><br><span class="line">savedialog.Filter = <span class="string">&quot;Jpg 图片|*.jpg|Bmp 图片|*.bmp|Gif 图片|*.gif|Png 图片|*.png|Wmf  图片|*.wmf&quot;</span>;</span><br><span class="line">savedialog.FilterIndex = <span class="number">0</span>;</span><br><span class="line">savedialog.RestoreDirectory = <span class="literal">true</span>;<span class="comment">//保存对话框是否记忆上次打开的目录</span></span><br><span class="line">savedialog.CheckPathExists = <span class="literal">true</span>;<span class="comment">//检查目录</span></span><br><span class="line">savedialog.FileName = System.DateTime.Now.ToString(<span class="string">&quot;yyyyMMddHHmmss&quot;</span>) + <span class="string">&quot;-&quot;</span>; ;<span class="comment">//设置默认文件名</span></span><br><span class="line"><span class="keyword">if</span> (savedialog.ShowDialog() == DialogResult.OK)</span><br><span class="line">&#123;</span><br><span class="line">    image.Save(savedialog.FileName, System.Drawing.Imaging.ImageFormat.Jpeg);<span class="comment">// image为要保存的图片</span></span><br><span class="line">    MessageBox.Show(<span class="keyword">this</span>, <span class="string">&quot;图片保存成功！&quot;</span>, <span class="string">&quot;信息提示&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="WPF获取文件-Win32"><a href="#WPF获取文件-Win32" class="headerlink" title="WPF获取文件(Win32)"></a>WPF获取文件(Win32)</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Microsoft.Win32.OpenFileDialog</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.Win32;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ButtonBase_OnClick</span>(<span class="params"><span class="built_in">object</span> sender, RoutedEventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> openFileDialog = <span class="keyword">new</span> OpenFileDialog();</span><br><span class="line">    <span class="keyword">if</span> (openFileDialog.ShowDialog() == <span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do something with the filename</span></span><br><span class="line">        MessageBox.Show(openFileDialog.FileName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You can also specify a filter, which will show only certain type of files, like this:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> openFileDialog = <span class="keyword">new</span> OpenFileDialog</span><br><span class="line">&#123;</span><br><span class="line">    Filter = <span class="string">&quot;Text files (*.txt)|*.txt|All files (*.*)|*.*&quot;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="WPF另存为"><a href="#WPF另存为" class="headerlink" title="WPF另存为"></a>WPF另存为</h2><p>SaveFileDialog类位于PresentationFramework.dll 的Microsoft.Win32命名空间</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">ChooseSaveFile</span>(<span class="params"><span class="built_in">string</span> title,<span class="built_in">string</span> initFolder</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    SaveFileDialog dlg = <span class="keyword">new</span> SaveFileDialog();</span><br><span class="line">    dlg.Title = title;</span><br><span class="line">    dlg.FileName = <span class="string">&quot;User.txt&quot;</span>; <span class="comment">// Default file name</span></span><br><span class="line">    dlg.DefaultExt = <span class="string">&quot;.txt&quot;</span>; <span class="comment">// Default file extension</span></span><br><span class="line">    dlg.Filter = <span class="string">&quot;Text documents|*.txt&quot;</span>; <span class="comment">// Filter files by extension</span></span><br><span class="line">    dlg.InitialDirectory = initFolder;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process save file dialog box results</span></span><br><span class="line">    <span class="keyword">if</span> (dlg.ShowDialog() == <span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> dlg.FileName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="通用获取文件夹-Ookii"><a href="#通用获取文件夹-Ookii" class="headerlink" title="通用获取文件夹(Ookii)"></a>通用获取文件夹(Ookii)</h2><p>Another typical case is when you need the user to select a folder. This time a File Dialog won’t do the job and you’ll need something different. If you’ve ever used WinForms you’d probably know FolderBrowserDialog class. Unfortunately this is not available in WPF by default, but don’t worry, you can still solve this in at least 3 different ways:</p>
<ol>
<li>Add the System.Windows.Forms DLL and use the FolderBrowserDialog class</li>
<li>Install the <a target="_blank" rel="noopener" href="https://www.nuget.org/packages/Ookii.Dialogs/">Ookii.Dialogs nuget</a> and use the VistaFolderBrowserDialog class</li>
<li>Install the <a target="_blank" rel="noopener" href="https://www.nuget.org/packages/Microsoft.WindowsAPICodePack-Shell">Windows API Code Pack-Shell</a> and use the CommonOpenFileDialog class</li>
</ol>
<p>The one I use the most is the Ookii.Dialogs one which looks easier and simpler to me. Just use this snippet and you’re ready to go:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ButtonBase2_OnClick</span>(<span class="params"><span class="built_in">object</span> sender, RoutedEventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> ookiiDialog = <span class="keyword">new</span> VistaFolderBrowserDialog();</span><br><span class="line">    <span class="keyword">if</span> (ookiiDialog.ShowDialog() == DialogResult.OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do something with the folder path</span></span><br><span class="line">        MessageBox.Show(ookiiDialog.SelectedPath);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div><a class="button-hover more" href="/2025/01/25/csharp-popups/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/2025/01/25/csharp-efcore/">EF Core 快速开始</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2025-01-25</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/csharp/">csharp</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/csharp/">csharp</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/asp-net/">asp.net</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/microsoft/">microsoft</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/ef-core/">ef core</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/dotnet/">dotnet</a></div></div><div class="post-content"><div class="main-content content"><h1 id="EF-Core-快速开始"><a href="#EF-Core-快速开始" class="headerlink" title="EF Core 快速开始"></a>EF Core 快速开始</h1><h2 id="安装ef包"><a href="#安装ef包" class="headerlink" title="安装ef包"></a>安装ef包</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Microsoft.EntityFrameworkCore.Sqlite</span><br><span class="line">Microsoft.EntityFrameworkCore.Design</span><br></pre></td></tr></table></figure>

<p>注意不要安装成<code>Microsoft.EntityFrameworkCore.Sqlite.Core</code>最后带<strong>core</strong>结尾的不是。</p>
<h2 id="实体模型"><a href="#实体模型" class="headerlink" title="实体模型"></a>实体模型</h2><p>建个文件夹比如<strong>Db</strong>存放所有的实体模型。数据库Context类如下</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">EasyRepo.Db</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MainContext</span> : <span class="title">DbContext</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MainContext</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MainContext</span>(<span class="params">DbContextOptions&lt;MainContext&gt; options</span>) : <span class="title">base</span>(<span class="params">options</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;ItemCategory&gt; ItemCategories &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;ItemProvider&gt; ItemProviders &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;InputItem&gt; InputItems &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;OutputItem&gt; OutputItems &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnConfiguring</span>(<span class="params">DbContextOptionsBuilder optionsBuilder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!optionsBuilder.IsConfigured)</span><br><span class="line">            &#123;</span><br><span class="line">                optionsBuilder.UseSqlite(<span class="string">&quot;Data Source=data.db&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中一个实体类模板如下</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">EasyRepo.Db</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InputItem</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Key</span>]</span><br><span class="line">        [<span class="meta">DatabaseGenerated(DatabaseGeneratedOption.Identity)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        </span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> DateTime InputDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        </span><br><span class="line">        [<span class="meta">ForeignKey(<span class="string">&quot;CategoryId&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> ItemCategory Category &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        </span><br><span class="line">        [<span class="meta">AllowNull</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Itemname &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        </span><br><span class="line">        [<span class="meta">ForeignKey(<span class="string">&quot;ProviderId&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> ItemProvider Provider &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        </span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">decimal</span> Count &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        </span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">decimal</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        </span><br><span class="line">        [<span class="meta">AllowNull</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Note &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意数据库一个表的外键必须使用诸如<strong>CategoryId</strong>这样的命名方式，否则迁移会报错。</p>
<h2 id="迁移数据"><a href="#迁移数据" class="headerlink" title="迁移数据"></a>迁移数据</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 新建迁移</span><br><span class="line">dotnet ef migrations add InitialCreate</span><br><span class="line"></span><br><span class="line"># 开始创建数据库</span><br><span class="line">dotnet ef database update</span><br><span class="line"></span><br><span class="line"># 如果提示版本过低，升级 ef 工具版本</span><br><span class="line">dotnet tool update --global dotnet-ef</span><br></pre></td></tr></table></figure>

<h2 id="不使用依赖注入"><a href="#不使用依赖注入" class="headerlink" title="不使用依赖注入"></a>不使用依赖注入</h2><p>如果不用类似ASP.NET那样的依赖注入来使用数据库，需要在 DbContext 同级目录下创建一个 <code>DesignTimeDbContextFactory.cs</code> 类</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">EasyRepo.Db</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DesignTimeDbContextFactory</span> : <span class="title">IDesignTimeDbContextFactory</span>&lt;<span class="title">MainContext</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> MainContext <span class="title">CreateDbContext</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> optionsBuilder = <span class="keyword">new</span> DbContextOptionsBuilder&lt;MainContext&gt;();</span><br><span class="line">            optionsBuilder.UseSqlite(<span class="string">&quot;Data Source=data.db&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MainContext(optionsBuilder.Options);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样让ef工具正确识别如何新建数据库。</p>
</div></div><a class="button-hover more" href="/2025/01/25/csharp-efcore/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/2025/01/25/diy-mi-band-4/">小米手环 4 手动同步 bin 表盘</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2025-01-25</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/diy/">diy</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/electronics/">electronics</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/diy/">diy</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/mi/">mi</a></div></div><div class="post-content"><div class="main-content content"><h1 id="小米手环-4-手动同步-bin-表盘"><a href="#小米手环-4-手动同步-bin-表盘" class="headerlink" title="小米手环 4 手动同步 bin 表盘"></a>小米手环 4 手动同步 bin 表盘</h1><h2 id="方法一（不推荐）"><a href="#方法一（不推荐）" class="headerlink" title="方法一（不推荐）"></a>方法一（不推荐）</h2><h3 id="1-小米运动下载一个表盘"><a href="#1-小米运动下载一个表盘" class="headerlink" title="1. 小米运动下载一个表盘"></a>1. 小米运动下载一个表盘</h3><p>从小米运动里随便找个表盘，记住找的哪一个，然后同步</p>
<h3 id="2-替换文件"><a href="#2-替换文件" class="headerlink" title="2. 替换文件"></a>2. 替换文件</h3><p>在</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">此电脑\Redmi K30 Pro\内部存储设备\Android\data\com.xiaomi.hm.health\files\watch_skin_local</span><br></pre></td></tr></table></figure>

<p>内找到刚下载的表盘，表盘是一个文件夹，名字类似<code>7ec60bf34ee7258203b9379495505706</code></p>
<p>打开里面有缩略图</p>
<h3 id="3-再次同步"><a href="#3-再次同步" class="headerlink" title="3. 再次同步"></a>3. 再次同步</h3><p>将文件夹内的bin替换成下载的第三方bin，回到小米运动app，打开刚才下的表盘，点击立即同步</p>
<h2 id="方法二（推荐）"><a href="#方法二（推荐）" class="headerlink" title="方法二（推荐）"></a>方法二（推荐）</h2><p>手动构造表盘文件夹，先随便新建个文件夹</p>
<h3 id="1-XML"><a href="#1-XML" class="headerlink" title="1. XML"></a>1. XML</h3><p>在文件夹内创建<code>infos.xml</code> XML 文件</p>
<p>名称为 <code>infos.xml</code>注意是 <strong>infos</strong> 不是 <strong>info</strong> </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27; standalone=&#x27;yes&#x27; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">watch_skin_info</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">info</span>&gt;</span>&#123;&quot;O00000oO&quot;:&quot;表盘名称&quot;,&quot;O00000oo&quot;:0,&quot;O0000O0o&quot;:103587,&quot;O0000OOo&quot;:0,&quot;O0000Oo&quot;:false&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">info</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">watch_skin_info</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-图片"><a href="#2-图片" class="headerlink" title="2. 图片"></a>2. 图片</h3><p>相同目录下放入一个 <code>120X240</code> 的<code>png</code>格式图片用于预览图</p>
<h3 id="3-bin"><a href="#3-bin" class="headerlink" title="3. bin"></a>3. bin</h3><p>相同目录下放入下载的bin文件</p>
<h3 id="4-打包"><a href="#4-打包" class="headerlink" title="4. 打包"></a>4. 打包</h3><p>以上所有三个文件放入同一文件夹，把这个文件夹放到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">此电脑\Redmi K30 Pro\内部存储设备\Android\data\com.xiaomi.hm.health\files\watch_skin_local</span><br></pre></td></tr></table></figure>

<h3 id="附：方法二自动打包，调用-aio-函数即可"><a href="#附：方法二自动打包，调用-aio-函数即可" class="headerlink" title="附：方法二自动打包，调用 aio 函数即可"></a>附：方法二自动打包，调用 <code>aio</code> 函数即可</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">从网上下载符合要求的图片和 bin 文件，打开此程序</span></span><br><span class="line"><span class="string">输入文件名后自动处理打包</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> PySimpleGUI <span class="keyword">as</span> sg</span><br><span class="line"></span><br><span class="line">HELP = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">从网上下载符合要求的图片和 bin 文件，</span></span><br><span class="line"><span class="string">并放在此程序所在的文件夹，</span></span><br><span class="line"><span class="string">打开此程序，输入一个自定义的名字</span></span><br><span class="line"><span class="string">此软件自动处理打包</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">XML = <span class="string">&quot;&quot;&quot;&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27; standalone=&#x27;yes&#x27; ?&gt;&lt;watch_skin_info&gt;&lt;info&gt;&#123;&quot;O00000oO&quot;:&quot;&#123;&#123;NAME&#125;&#125;&quot;,&quot;O00000oo&quot;:0,&quot;O0000O0o&quot;:103587,&quot;O0000OOo&quot;:0,&quot;O0000Oo&quot;:false&#125;&lt;/info&gt;&lt;/watch_skin_info&gt;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_xml</span>(<span class="params">folder, name</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; generate the XML template and write it to XML file &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&#x27;<span class="subst">&#123;folder&#125;</span>/infos.xml&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(XML.replace(<span class="string">&#x27;&#123;&#123;NAME&#125;&#125;&#x27;</span>, name))</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">name_is_pic</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;check whether the file is picture</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    checks: &#x27;webp&#x27;, &#x27;jpg&#x27;, &#x27;jpeg&#x27;, &#x27;gif&#x27;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    ext = name.split(<span class="string">&#x27;.&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> ext <span class="keyword">in</span> &#123;<span class="string">&#x27;webp&#x27;</span>, <span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>&#125;:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert_png</span>(<span class="params">folder</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; 把图片后缀改成png &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> os.listdir(folder):</span><br><span class="line">        <span class="comment"># base name</span></span><br><span class="line">        name_without_ext = file.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># is picture</span></span><br><span class="line">        <span class="keyword">if</span> name_is_pic(file):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[I] 转换图片: %s&#x27;</span> % file)</span><br><span class="line">            os.system(<span class="string">f&#x27;magick &quot;<span class="subst">&#123;folder&#125;</span>\\<span class="subst">&#123;file&#125;</span>&quot; &quot;<span class="subst">&#123;folder&#125;</span>\\<span class="subst">&#123;name_without_ext&#125;</span>.png&quot;&#x27;</span>)</span><br><span class="line">            <span class="comment"># list dirs again to check the num of png</span></span><br><span class="line">            pngs = [i <span class="keyword">for</span> i <span class="keyword">in</span> os.listdir(folder) <span class="keyword">if</span> i.endswith(<span class="string">&#x27;.png&#x27;</span>)]</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(pngs) &gt; <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> pngs[<span class="number">1</span>:]:</span><br><span class="line">                    os.remove(<span class="string">f&#x27;<span class="subst">&#123;folder&#125;</span>\\<span class="subst">&#123;j&#125;</span>&#x27;</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;[I] 删除: %s&#x27;</span> % j)</span><br><span class="line">            os.remove(<span class="string">f&#x27;<span class="subst">&#123;folder&#125;</span>\\<span class="subst">&#123;file&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[I] 删除: %s&#x27;</span> % file)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[X] 文件夹 %s 内没有图片文件。&#x27;</span> % folder)</span><br><span class="line">            </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aio</span>(<span class="params">skin_name</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    give me the skin name and i will do all things, </span></span><br><span class="line"><span class="string">    return a str describe the status</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    skin = <span class="string">&#x27;no&#x27;</span></span><br><span class="line">    pic = <span class="string">&#x27;no&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(skin_name):</span><br><span class="line">            os.mkdir(skin_name)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">for</span> this_folder_file <span class="keyword">in</span> os.listdir(<span class="string">&#x27;./&#x27;</span>):</span><br><span class="line">        <span class="comment"># find Bin file!</span></span><br><span class="line">        <span class="keyword">if</span> this_folder_file.endswith(<span class="string">&#x27;.bin&#x27;</span>):</span><br><span class="line">            skin = <span class="string">&#x27;yes&#x27;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[I] 识别表盘：%s&#x27;</span> % this_folder_file)</span><br><span class="line">            bin_file = this_folder_file</span><br><span class="line">            <span class="comment"># move it</span></span><br><span class="line">            shutil.move(bin_file, <span class="string">f&#x27;<span class="subst">&#123;skin_name&#125;</span>/<span class="subst">&#123;bin_file&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="comment"># generate template</span></span><br><span class="line">            write_xml(skin_name, skin_name)</span><br><span class="line">            <span class="comment"># whether to download picture</span></span><br><span class="line">        <span class="keyword">elif</span> name_is_pic(this_folder_file):</span><br><span class="line">            pic = <span class="string">&#x27;yes&#x27;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[I] 识别图片：%s&#x27;</span> % this_folder_file)</span><br><span class="line">            <span class="comment"># move the picture to the directory</span></span><br><span class="line">            shutil.move(this_folder_file, <span class="string">f&#x27;<span class="subst">&#123;skin_name&#125;</span>\\<span class="subst">&#123;this_folder_file&#125;</span>&#x27;</span>)</span><br><span class="line">            convert_png(skin_name)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;完成，检测到皮肤：<span class="subst">&#123;skin&#125;</span>，检测到图片：<span class="subst">&#123;pic&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gui</span>():</span><br><span class="line">    f = (<span class="string">&#x27;微软雅黑&#x27;</span>, <span class="number">16</span>)</span><br><span class="line">    sg.theme(<span class="string">&#x27;Dark&#x27;</span>)</span><br><span class="line">    layout = [</span><br><span class="line">        [sg.Text(<span class="string">&#x27;表盘名称&#x27;</span>, font=f),</span><br><span class="line">         sg.InputText(key=<span class="string">&#x27;-NAME-&#x27;</span>, font=f, size=(<span class="number">20</span>, <span class="number">1</span>))],</span><br><span class="line">        </span><br><span class="line">        [sg.Text(<span class="string">&#x27;Ready&#x27;</span>, key=<span class="string">&#x27;-STATUS-&#x27;</span>, size=(<span class="number">30</span>, <span class="number">1</span>),font=f)],</span><br><span class="line">        </span><br><span class="line">        [sg.Button(<span class="string">&#x27;生成！&#x27;</span>, font=f),</span><br><span class="line">         sg.Button(<span class="string">&#x27;退出&#x27;</span>, font=f), </span><br><span class="line">         sg.Button(<span class="string">&#x27;帮助&#x27;</span>, font=f)]</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    window = sg.Window(<span class="string">&#x27;小米手环4表盘生成器&#x27;</span>, layout)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        event, values = window.read()</span><br><span class="line">        <span class="built_in">print</span>(event, values)</span><br><span class="line">        <span class="keyword">if</span> event == sg.WIN_CLOSED <span class="keyword">or</span> event == <span class="string">&#x27;退出&#x27;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">elif</span> event == <span class="string">&#x27;生成！&#x27;</span>:</span><br><span class="line">            text = values[<span class="string">&#x27;-NAME-&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> text:</span><br><span class="line">                window[<span class="string">&#x27;-STATUS-&#x27;</span>].update(<span class="string">&#x27;Skin name is required!&#x27;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            output = aio(text)</span><br><span class="line">            window[<span class="string">&#x27;-STATUS-&#x27;</span>].update(output)</span><br><span class="line">        <span class="keyword">elif</span> event == <span class="string">&#x27;帮助&#x27;</span>:</span><br><span class="line">            sg.popup(<span class="string">&#x27;帮助&#x27;</span>, HELP, font=f)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># aio(&#x27;tttttttttttttt&#x27;)</span></span><br><span class="line">    <span class="comment"># convert_png(&#x27;ProstoFace Orange&#x27;)</span></span><br><span class="line">    gui()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</div></div><a class="button-hover more" href="/2025/01/25/diy-mi-band-4/#more">阅读全文</a></div></div><div id="pagination"><div class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fas fa-angle-right"></i></a></div></div></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fas fa-user"></i></span><span id="busuanzi_value_site_uv"></span><span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fas fa-eye"></i></span><span id="busuanzi_value_site_pv"></span><span></span></div><div class="copyright">&copy;2017 ～ 2025 By TaylorAndTony</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="/js/search/algolia.js"></script></body></html>